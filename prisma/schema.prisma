// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  USER
  ADMIN
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

enum RefundStatus {
  PENDING
  SUCCESS
  FAILED
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE  
  EXPIRED 
  CANCELED 
  REFUNDED
  PAST_DUE
}

enum DrawTime {
  MID
  EVE
}

enum GameResultStatus {
  WIN
  LOSS
  PENDING
}

model User {
  id           Int       @id @default(autoincrement())
  firstName     String? @map("first_name")
  lastName     String? @map("last_name")
  email        String    @unique
    phoneNo      String?   @unique @map("phone_no")
  passwordHash String    @map("password_hash")
  role         Role    @default(USER)
  refreshToken String?   @map("refresh_token")
    stripeCustomerId       String?   @unique @map("stripe_customer_id")
  stateId      Int?      @map("state_id")

    isTrial  Boolean     @default(false)
    
  isInactive    Boolean   @default(false) @map("is_inactive")
  forgotHashKey      String?   @unique
  forgotHashExpiresAt DateTime? @db.Timestamptz
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  state                  State?   @relation(fields: [stateId], references: [id], onDelete: SetNull)
  uploads               Upload[]
  subscriptions         UserSubscription[]
  payments              Payment[]
  refunds               Refund[]
  @@map("users")
}

model Upload {
  id                  Int       @id @default(autoincrement())
  userId              Int       @map("user_id")
  cloudinaryPublicId  String    @map("cloudinary_public_id")
  cloudinaryUrl       String    @map("cloudinary_url")
  cloudinarySecureUrl String    @map("cloudinary_secure_url")
  resourceType        String?   @map("resource_type")
  format              String?
  width               Int?
  height              Int?
  bytes               Int?
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz
  
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("uploads")
}

model Support {
  id        Int      @id @default(autoincrement())
  name      String
  email     String
  subject   String
  category  String
  priority  String
  message   String

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

    @@map("supports")
}

model SubscriptionPlan {
  id            Int       @id @default(autoincrement()) 
  name          String    @unique
  price         Float?
  duration      Int?     // Month
  trialDays     Int?     // Days

  description   String?
   discountPercent Float?  @default(0)
  isRecommended Boolean   @default(false)
  isActive      Boolean   @default(true) @map("is_active")

  stripeProductId    String?   @unique
  stripePriceId      String?   @unique

  features      Feature[]
  subscriptions UserSubscription[]
  scheduledSubscriptions UserSubscription[] @relation("NextPlan")

  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz

   isDeleted     Boolean   @default(false)
  deletedAt     DateTime? @db.Timestamptz

  @@map("subscription_plans")
}

model Feature {
  id        Int       @id @default(autoincrement()) 
  planId    Int      
  name      String
  description String?

  plan      SubscriptionPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

   isDeleted     Boolean   @default(false)
  deletedAt     DateTime? @db.Timestamptz

  @@map("features")
}

model UserSubscription {
  id                     Int      @id @default(autoincrement())
  userId                 Int     
  planId                 Int     
  startDate              DateTime @map("start_date") @db.Timestamptz
  endDate                DateTime @map("end_date") @db.Timestamptz
  
  stripeSubscriptionId   String?   @unique
  paymentId              Int?    

  status                 SubscriptionStatus @default(ACTIVE) 

  nextPlanId             Int?
  scheduledChangeAt      DateTime? @db.Timestamptz

  user                   User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan                   SubscriptionPlan @relation(fields: [planId], references: [id])
  payment                Payment?         @relation(fields: [paymentId], references: [id])
   nextPlan               SubscriptionPlan?  @relation("NextPlan", fields: [nextPlanId], references: [id])

    createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz

   isDeleted     Boolean   @default(false)
  deletedAt     DateTime? @db.Timestamptz

  @@map("user_subscriptions")
}

model Payment {
  id               Int           @id @default(autoincrement())
  userId           Int          
  amount           Float
  status           PaymentStatus
  paymentMethod    String
  stripePaymentId  String        @unique

  user             User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscription     UserSubscription[]
  refund           Refund?

  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz

   isDeleted     Boolean   @default(false)
  deletedAt     DateTime? @db.Timestamptz

  @@map("payments")
}

model Refund {
  id              Int           @id @default(autoincrement()) 
  paymentId       Int           @unique 
  userId          Int           
  amount          Float
  status          RefundStatus
  stripeRefundId  String        @unique

  payment         Payment       @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)

    createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz

   isDeleted     Boolean   @default(false)
  deletedAt     DateTime? @db.Timestamptz

  @@map("refunds")
}

model State {
  id          Int          @id @default(autoincrement())
  name        String       @unique
  code        String?      @unique // State abbreviation (e.g., "CA", "NY")
  isActive    Boolean      @default(true) @map("is_active")
  
  users       User[]
  gameHistory GameHistory[]

  createdAt   DateTime     @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime     @updatedAt @map("updated_at") @db.Timestamptz
  
  isDeleted   Boolean      @default(false)
  deletedAt   DateTime? @db.Timestamptz

  @@map("states")
}

model GameType {
  id          Int          @id @default(autoincrement())
  name        String       @unique // e.g., "Pick3", "Pick4", "Pick5"
  code        String?      @unique // Short code for the game type
  description String?
  isActive    Boolean      @default(true) @map("is_active")
  
  gameHistory GameHistory[]

  createdAt   DateTime     @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime     @updatedAt @map("updated_at") @db.Timestamptz
  
  isDeleted   Boolean      @default(false)
  deletedAt   DateTime? @db.Timestamptz

  @@map("game_types")
}

model GameHistory {
  id              Int              @id @default(autoincrement())
  stateId         Int              @map("state_id")
  gameTypeId      Int              @map("game_type_id")
  drawDate        DateTime         @map("draw_date") @db.Timestamptz // Date of the draw
  drawTime        DrawTime         @map("draw_time")
  winningNumbers  String           @map("winning_numbers") // e.g., "123", "0456"
  resultStatus    GameResultStatus @default(PENDING) @map("result_status")
  totalWinners    Int              @default(0) @map("total_winners")
  prizeAmount     Decimal?         @map("prize_amount") @db.Decimal(10, 2)
  state           State            @relation(fields: [stateId], references: [id], onDelete: Restrict)
  gameType        GameType         @relation(fields: [gameTypeId], references: [id], onDelete: Restrict)

  createdAt       DateTime         @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime         @updatedAt @map("updated_at") @db.Timestamptz

  // Prevent duplicate entries for same state + game + draw date + draw time
  @@unique([stateId, gameTypeId, drawDate, drawTime], name: "unique_draw")
  @@index([stateId, gameTypeId])
  @@index([drawDate])
  @@index([resultStatus])
  @@map("game_history")
}
